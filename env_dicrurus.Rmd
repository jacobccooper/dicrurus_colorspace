---
title: "Dicrurus Colorspace"
output: github_document
---

Occurrences come from a georeferenced specimen database and from the Global Biodiversity Informatics Facility, specifically: GBIF.org (10 March 2022) GBIF Occurrence Download https://doi.org/10.15468/dl.b5q394 

```{r,echo=F}
rm(list=ls())
filepath="~/Dropbox/Manuscripts/Dicrurus/"
gis="~/Dropbox/GIS/"
```
```{r}
library(data.table)
library(factoextra)
library(maptools)
library(MASS)
library(raster)
library(rnaturalearth)
library(rnaturalearthhires)
library(rgdal)
library(sf)
library(tidyverse)
library(vegan)
```

# Specimen Localities

Import coordinates for colorspace specimens from KMZ file.

```{r}
# converted from KMZ in QGIS

ocean=readOGR(paste0(gis,"ne_10m_ocean/ne_10m_ocean.shp"))
lakes=readOGR(paste0(gis,"ne_10m_lakes/ne_10m_lakes.shp"))
elev=raster(paste0(gis,"elevation_1KMmd_GMTEDmd.tif"))
specimen.xy=readOGR(paste0(filepath,"dicrurus.gpkg"))

xlim=c(extent(specimen.xy)[1:2])
ylim=c(extent(specimen.xy)[3:4])
```
```{r}
plot(elev,xlim=xlim*1.1,ylim=ylim*1.1)
plot(ocean,col="#A6BBFF",add=T)
plot(lakes,col="#A6BBFF",add=T)
points(specimen.xy,col="black",pch=19)
```

Link the occurrences with specimen metadata. This has to be done based on placenames.

```{r,eval=F}
specimen.data=specimen.xy@data
specimen.data=cbind(specimen.xy@coords,specimen.data)
colnames(specimen.data)[1]="Long"
colnames(specimen.data)[2]="Lat"
specimen.data=specimen.data%>%
  dplyr::select(Long,Lat,Name)

for(i in 1:nrow(specimen.data)){
  loc=specimen.data$Name[i]
  specimen.data$Name[i]=strsplit(loc,") ")[[1]][2]
}

write_csv(specimen.data,paste0(filepath,"localities.csv"))
```

I checked names externally to be sure they matched up. There are a lot of localities missing from the KMZ - so I've kicked it back to the others for verification of localities.

```{r}
utms=read_csv(paste0(filepath,'dicrurus_utm.csv'))

utms$Lat=utms$Long=0


```

## Merge with GBIF

We are going to merge the above with GBIF data.

```{r,eval=F}
# read GBIF
gbif=read.delim(paste0(filepath,"dicrurus_gbif.csv"),
             sep="\t") # specify tab separation

# remove extraneous columns
# parse to relevant columns
gbif=gbif%>%
  # remove gridded data as determined in QGIS
  filter(institutionCode!='6992',
         institutionCode!='6993',
         institutionCode!='APLORI',
         institutionCode!='FIAO')%>%
  dplyr::select(genus,species,infraspecificEpithet,
         scientificName,individualCount,
         decimalLongitude,decimalLatitude,coordinateUncertaintyInMeters,
         coordinatePrecision,
         day,month,year,countryCode)

# write reduced file
write_csv(gbif,file=paste0(filepath,"reduced_gbif.csv"))

# remove NA vals from uncertatainty
# assume accurate unless states otherwise
gbif[is.na(gbif$coordinateUncertaintyInMeters),
  "coordinateUncertaintyInMeters"]=0

# localities only
gbif=gbif%>%
  # remove uncertainty over 10km
  filter(coordinateUncertaintyInMeters<=10000)%>%
  select(species,infraspecificEpithet,
         decimalLongitude,decimalLatitude,
         countryCode,month)%>%
  # get unique
  unique()

write_csv(gbif,file = paste0(filepath,"dicrurus_gbif_localities.csv"))
```
```{r}
gbif=read_csv(paste0(filepath,"dicrurus_gbif_localities.csv"))
```
```{r}
plot(elev,xlim=xlim*1.1,ylim=ylim*1.1)
plot(ocean,col="#A6BBFF",add=T)
plot(lakes,col="#A6BBFF",add=T)
points(specimen.xy,col="red",pch=19)
points(gbif$decimalLongitude,gbif$decimalLatitude,
       col="black",pch=".")
```

The samples specimens cover a lot more of northeastern Africa than the other data. Note how data-dense Southern Africa is relative to the rest of the continent!

Prepare data for merge.

```{r}
# create voucher column

colnames(gbif)=c("SciName","Subspecies","Long","Lat","Country","Month")

# only gbif data for now; to be changed later

gbif=gbif%>%
  dplyr::select(SciName,Subspecies,Long,Lat)

write_csv(gbif,paste0(filepath,"combined_data.csv"))
```

# Population assignation

Ensure that populations are correctly assigned. This is where things get tricky! Note that specimens are likely correctly attributed.

```{r}
data=read_csv(paste0(filepath,"combined_data.csv"))

data$SciName=as.factor(data$SciName)
data$Subspecies=as.factor(data$Subspecies)
summary(data)
```

```{r}
unique(data$SciName)
```

Looks like all twelve species are here. We need to make sure we have all species ascribed correctly.

```{r}
species.plotter=function(sciname,data){
  data2=data%>%
    filter(SciName==sciname)%>%
    dplyr::select(Long,Lat)
  
  plot(elev,xlim=xlim*1.1,ylim=ylim*1.1)
  plot(ocean,col="#A6BBFF",add=T)
  plot(lakes,col="#A6BBFF",add=T)
  points(data2,col="black",pch=19)
}
```

## *Dicrurus occidentalis*

```{r}
which(data$Subspecies%like%"occidentalis")
```
There is nothing ascribed to the subspecies *occidentalis*.

```{r}
species.plotter(data=data,sciname="Dicrurus occidentalis")
```

All individuals are within the range of *D. occidentalis*.

## *Dicrurus sharpei*

```{r}
data[which(data$Subspecies%like%"sharpei"),]
```
There are several misclassified *D. ludwigii* still.

```{r}
index=which(data$Subspecies%like%"sharpei")

data[index,"SciName"]="Dicrurus sharpei"
data[index,"Subspecies"]=NA
```

```{r}
species.plotter(data=data,sciname="Dicrurus sharpei")
```

There are lots of erroneous western records, which refer to *D. occidentalis*.

```{r}
data[which(data$SciName%like%"sharpei"&data$Long<3.45),
     "SciName"]="Dicrurus occidentalis"
```


## *Dicrurus ludwigii*

This species consists of the following subspecies:

1. *saturnus* from Angola to Katanga and Zambia
2. *muenzneri* from Somalia, Kenya, and Tanzania (coastal?)
3. *tephrogaster* from Malawi, Zimbabwi, and Mozambique "north of Limpopo River"
4. *ludwigii* for all localities S of Limpopo R

```{r}
unique(data$Subspecies[data$SciName%like%"ludwigii"])
```
All subspecies appear to be part of the species complex. Strangely, no *saturnus* are labeled in the group.

```{r}
species.plotter(data=data,sciname = "Dicrurus ludwigii")
```

*Note* that populations in W Africa are labeled incorrectly. Using the above threshold:

```{r}
data[which(data$SciName%like%"ludwigii"&data$Long<3.45),
     "SciName"]="Dicrurus occidentalis"
data[which(data$SciName%like%"ludwigii"&
             data$Long<20&data$Lat>0),
     "SciName"]="Dicrurus sharpei"
```

## *Dicrurus atripennis*

```{r}
unique(data$Subspecies[data$SciName%like%"atripennis"])
```
No subspecies, as expected.

```{r}
species.plotter(sciname = "Dicrurus atripennis",data=data)
```
There are some northerly, almost sehelian records that are surprising. The only one that we can immediately say is in error is the Kenyan record.

```{r}
data=data[-which(data$SciName%like%"atripennis"&
             data$Long>32.5),]
```

## *Dicrurus adsimilis*

```{r}
summary(data$Subspecies[data$SciName%like%"adsimilis"])
```

Most of these are NA; we need to correct them to subspecies.



## *Dicrurus divaricatus*

## *Dicrurus atactus*

## *Dicrurus modestus*

## *Dicrurus aldabranus*

## *Dicrurus fuscipennis*

## *Dicrurus forficatus*

## *Dicrurus waldenii*

# Extract Environmental Data

```{r}
env_layers=paste0(gis,"ENVIREM_30arcsec/",
  list.files(paste0(gis,"ENVIREM_30arcsec/"),pattern="*.bil"))

# remove set count files

```

